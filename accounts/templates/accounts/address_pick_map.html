<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>지도에서 위치 확인</title>
  {% if kakao_js_key %}
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_js_key }}&libraries=services"></script>
  {% endif %}
</head>
<body>
  <a href="{% url 'accounts:address_settings' %}">←</a>
  <h1>지도에서 위치 확인</h1>

  <!-- 지도 -->
  <div id="map" style="width:100%;height:360px;"></div>

  <!-- 주소 미리보기 + 경고 -->
  <div>
    <h3 id="addr-title">주소를 불러오는 중…</h3>
    <p id="addr-sub" style="color:#666"></p>
    <p style="color:#d33">지도의 표시와 실제 주소가 맞는지 확인해주세요.</p>
  </div>

  <!-- 현재 위치로 이동 버튼 -->
  <button type="button" id="btn-geolocate">현재 위치로 이동</button>

  <!-- 이 위치로 등록 (상세주소 입력 페이지로 이동) -->
<form id="save-direct" method="post" action="{% url 'accounts:address_save_from_map' %}">
  {% csrf_token %}
  <input type="hidden" name="name" id="f-name">
  <input type="hidden" name="l1"   id="f-l1">
  <input type="hidden" name="l2"   id="f-l2">
  <input type="hidden" name="l3"   id="f-l3">
  <input type="hidden" name="lat"  id="f-lat">
  <input type="hidden" name="lng"  id="f-lng">
  <!-- (선택) 상세주소 입력 필드도 여기서 받을 수 있어요 -->
  <input type="text" name="detail" placeholder="동/호수 등 상세주소(선택)">
  <button type="submit">이 위치로 주소 등록</button>
</form>

<script>
(function(){
  // 초기 중심(백엔드 폴백)
  var initLat = parseFloat("{{ init_lat }}");
  var initLng = parseFloat("{{ init_lng }}");

  if (!window.kakao || !kakao.maps) {
    alert("지도를 불러오지 못했습니다. 잠시 후 다시 시도해 주세요.");
    return;
  }

  var map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(initLat, initLng),
    level: 3
  });

  var geocoder = new kakao.maps.services.Geocoder();

  // 중앙 핀(드래그로 위치 바꿀 때 중심에 따라 움직임)
  var marker = new kakao.maps.Marker({
    position: map.getCenter(),
    draggable: false
  });
  marker.setMap(map);

  // 중앙 좌표가 바뀔 때마다 역지오코딩해서 폼/텍스트 갱신
  function updateCenterInfo() {
    var center = map.getCenter();
    marker.setPosition(center);

    var lat = center.getLat(), lng = center.getLng();
    document.getElementById('f-lat').value = lat.toFixed(6);
    document.getElementById('f-lng').value = lng.toFixed(6);

    geocoder.coord2Address(lng, lat, function(result, status){
      if (status !== kakao.maps.services.Status.OK || !result || !result.length){
        document.getElementById('addr-title').textContent = "주소를 찾을 수 없습니다";
        document.getElementById('addr-sub').textContent = "";
        document.getElementById('f-name').value = "";
        document.getElementById('f-l1').value = "";
        document.getElementById('f-l2').value = "";
        document.getElementById('f-l3').value = "";
        return;
      }
      // road_address 우선, 없으면 address(지번)
      var r = result[0];
      var road = r.road_address;
      var jibun = r.address;

      var name = (road && road.address_name) || (jibun && jibun.address_name) || "";
      var l1 = (road && road.region_1depth_name) || (jibun && jibun.region_1depth_name) || "";
      var l2 = (road && road.region_2depth_name) || (jibun && jibun.region_2depth_name) || "";
      var l3 = (road && road.region_3depth_name) || (jibun && jibun.region_3depth_name) || "";

      document.getElementById('addr-title').textContent = name || "주소 미확인";
      document.getElementById('addr-sub').textContent   = (l1 + " " + l2 + " " + l3).trim();

      document.getElementById('f-name').value = name;
      document.getElementById('f-l1').value = l1;
      document.getElementById('f-l2').value = l2;
      document.getElementById('f-l3').value = l3;
    });
  }

  // 지도를 끌거나 확대/축소 후 멈추면 갱신
  kakao.maps.event.addListener(map, 'idle', updateCenterInfo);

  // 페이지 첫 렌더에서는 백엔드 폴백 좌표 기준으로 먼저 갱신
  updateCenterInfo();

  // GPS 버튼: 권한 허용 시 현재 위치로 이동
  document.getElementById('btn-geolocate').addEventListener('click', function(){
    if (!navigator.geolocation) {
      alert("브라우저가 위치 정보를 지원하지 않습니다.");
      return;
    }
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = pos.coords.latitude;
      var lng = pos.coords.longitude;
      map.setCenter(new kakao.maps.LatLng(lat, lng));
      // idle 이벤트가 호출되며 updateCenterInfo가 실행됨
    }, function(err){
      alert("현재 위치를 가져오지 못했습니다. 권한을 허용했는지 확인해 주세요.");
      console.error(err);
    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
  });
})();
</script>
</body>
</html>
